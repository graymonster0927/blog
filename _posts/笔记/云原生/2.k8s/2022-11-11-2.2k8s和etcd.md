---
title: 2.2 k8s和etcd
date: 2022-11-11
categories: [笔记, '云原生', 'k8s']
tags: [云原生]
---


# k8s和etcd

## 思考

多少个peer最适合?
 * 1个?3个?5个?
 * 保证高可用是首要目标
 * 所有写操作都要经过leader
 * peer多了是否能提升集群并读操作的并发能力?
   * ➢ apiserver的配置只连本地的etcd peer
   * ➢ apiserver的配置指定所有etcd peers，但只有当前连接的etcd member异常,apiserver才会换目标
 * 需要动态flex up吗?

## 备份方案
 * etcd备份:备份完整的集群信息，灾难恢复
   * ➢ etcdctl snapshot save
 * 备份Kubernetes event
 * 频度?
 * 时间间隔太长:
   *  ➢ 能否接受user data lost?
   * ➢ 如果有外部资源配置，如负载均衡等，能否接受数据丢失导致的leak?
 * 时间间隔太短:
   * ➢ 对etcd的影响
   * ➢ 做snapshot的时候，etcd会锁住当前数据
   * ➢ 并发的写操作需要开辟新的空间进行增量写，导致磁盘空间增长
 * 如何保证备份的时效性，同时防止磁盘爆掉?
 * Auto defrag?

## Kubernetes中数据分离
* 对于大规模集群，大量的事件会对etcd造成压力
* API server 启动脚本中指定etcd servers集群

```
/usr/local/bin/kube-apiserver --etcd-servers=https://localhost:4001 --etcd- cafile=/etc/ssl/kubernetes/ca.crt--storage-backend=etcd3 --etcd-servers- overrides=/events#https://localhost:4002
```

## 优化运行参数
当网络延迟和磁盘延迟固定的情况下，可以优化etcd运行参数来提升集群的工作效率。etcd基于Raft 协议进行Leader选举，当Leader选定以后才能开始数据读写操作，因此频繁的Leader选举会导致数 据读写性能显著降低。可以通过调整心跳周期(Heatbeat Interval)和选举超时时间(Election Timeout)，来降低Leader选举的可能性。

心跳周期是控制Leader以何种频度向Follower发起心跳通知。心跳通知除表明Leader活跃状态之外， 还带有待写入数据信息，Follower依据心跳信息进行数据写入，默认心跳周期是100ms。选举超时时 间定义了当Follower多久没有收到Leader心跳，则重新发起选举，该参数的默认设置是1000ms。

如果etcd集群的不同实例部署在延迟较低的相同数据中心，通常使用默认配置即可。如果不同实例部 署在多数据中心或者网络延迟较高的集群环境，则需要对心跳周期和选举超时时间进行调整。建议心 跳周期参数推荐设置为接近etcd多个成员之间平均数据往返周期的最大值，一般是平均RTT的0.55- 1.5倍。如果心跳周期设置得过低，etcd会发送很多不必要的心跳信息，从而增加CPU和网络的负担。 如果设置得过高，则会导致选举频繁超时。选举超时时间也需要根据etcd成员之间的平均RTT时间来 设置。选举超时时间最少设置为etcd成员之间RTT时间的10倍，以便对网络波动。

心跳间隔和选举超时时间的值必须对同一个etcd集群的所有节点都生效，如果各个节点配置不同，就 会导致集群成员之间协商结果不可预知而不稳定。

## etcd备份存储
etcd的默认工作目录下会生成两个子目录:wal和snap。wal是用于存放预写式日志，其最大的 作用是记录整个数据变化的全部历程。所有数据的修改在提交前，都要先写入wal中。

snap是用于存放快照数据。为防止wal文件过多，etcd会定期(当wal中数据超过10000条记录 时，由参数“--snapshot-count”设置)创建快照。当快照生成后，wal中数据就可以被删除了。

如果数据遭到破坏或错误修改需要回滚到之前某个状态时，方法就有两个:一是从快照中恢复数 据主体，但是未被拍入快照的数据会丢失;而是执行所有WAL中记录的修改操作，从最原始的 数据恢复到数据损坏之前的状态，但恢复的时间较长。

## 备份方案实践

官方推荐etcd集群的备份方式是定期创建快照。和etcd内部定期创建快照的目的不同，该备份方式依赖外部 程序定期创建快照，并将快照上传到网络存储设备以实现etcd数据的冗余备份。上传到网络设备的数据，都 应进行了加密。即使当所有etcd实例都丢失了数据，也能允许etcd集群从一个已知的良好状态的时间点在任 一地方进行恢复。根据集群对etcd备份粒度的要求，可适当调节备份的周期。在生产环境中实测，拍摄快照 通常会影响集群当时的性能，因此不建议频繁创建快照。但是备份周期太长，就可能导致大量数据的丢失。

这里可以使用增量备份的方式。如图3-8所示，备份程序每30分钟触发一次快照的拍摄。紧接着它从快照结 束的版本(Revision)开始，监听etcd集群的事件，并每10秒钟将事件保存到文件中，并将快照和事件文件 上传到网络存储设备中。30分钟的快照周期对集群性能影响甚微。当大灾难来临时，也至多丢失10秒的数据。 至于数据修复，首先把数据从网络存储设备中下载下来，然后从快照中恢复大块数据，并在此基础上依次应 用存储的所有事件。这样就可以将集群数据恢复到灾难发生前。
 
