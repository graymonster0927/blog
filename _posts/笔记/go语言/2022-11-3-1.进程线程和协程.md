---
title: 1.进程/线程/协程
date: 2022-10-20
categories: [笔记, golang, 底层]
tags: [golang]
---


# 进程/线程/协程
 >进程和线程在linux内核下看是一种结构体(task_struct), 只不过支持多线程的进程是由一组task_struct来抽象，而这些task_struct会共享一些数据结构（例如内存描述符）
    而协程是一种轻量线程，它不是操作系统的线程，而是将一个操作系统线程分段使用，通过调度器实现协作式调度。
### 进程
  * 是分配系统资源(CPU 时间、内存等)的基本单位
  * 有独立的内存空间
  * 进程间通信
  * 独立性/安全性高


### 线程
  * 进程的一个执行流，是CPU调度并能独立运行的的基本单位 
  * 同一进程下多个线程共享进程内存空间/页表等 有自己的TLS
  * 多线程共享内存, 通信方便 但需要加锁
  * 相比进程独立性/安全性低

### 协程
  * 协程的调度完全由用户控制
  * 一个线程可以拥有多个协程，协程不是被操作系统内核所管理，而完全是由程序所控制
  * 默认栈大小只有几k 可以短时间创建大量协程

### Q&A
 * 为什么协程切换代价小?
   * 协程在用户空间 切换协程修改几个寄存器 不需要切换页表等 不需要上下文切换
   * 而进程/线程需要上下文切换 有内核态到用户态的切换开销 有内核栈/用户栈切换开销 有切换页表的开销 有缓存失效的开销
      * 直接开销
        * 切换页表全局目录(PGD)
        * 切换内核态堆栈
        * 切换硬件上下文(进程恢复前，必须装入寄存器的数据统称为硬件上下文)
        * 刷新TLB
        * 系统调度器的代码执行
      * 间接开销
        * CPU 缓存失效导致的进程需要到内存直接访问的 IO 操作变多 
* 使用进程/线程/协程的场景?
   * 为了安全性考虑, 比如nginx使用多进程 避免一个线程异常引起其他请求都异常
   * 效率 协程 - go GMP 当多进程/线程存在(高内存占用 调度的高消耗CPU)问题

