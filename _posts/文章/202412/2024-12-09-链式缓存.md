---
title: é“¾å¼ç¼“å­˜
date: 2024-12-09
categories: [æ–‡ç« , '202412']
tags: [goç»„ä»¶]
---

# ç®€ä»‹

ğŸ”—[GitHub](https://github.com/graymonster0927/component/tree/main/cachechain)

> ** å¯ä»¥å•ç‹¬ç”¨redisæ—è·¯ç¼“å­˜  å½“åšåˆ†å¸ƒå¼ç¼“å­˜ **

CacheChain æ˜¯ä¸€ä¸ªGoè¯­è¨€ç¼–å†™çš„é“¾å¼ç¼“å­˜ç®¡ç†åº“ï¼Œæä¾›çµæ´»ä¸”å¯æ‰©å±•çš„æ¥å£ï¼Œç”¨äºç®¡ç†å¤šçº§ç¼“å­˜å±‚ã€‚é€šè¿‡è¯¥åº“ï¼Œå¼€å‘è€…å¯ä»¥è½»æ¾åœ°ä¸å¤šç§ç¼“å­˜åç«¯ï¼ˆå¦‚å†…å­˜ç¼“å­˜ã€Redisç­‰ï¼‰è¿›è¡Œäº¤äº’ï¼Œæ‰§è¡Œç¼“å­˜çš„ Getã€Setã€Clear ç­‰æ“ä½œï¼Œå¹¶å…·å¤‡é”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶ã€‚


### ä¼˜ç‚¹
 * å®ç°redisæ—è·¯ç¼“å­˜, æ”¯æŒpipelineæ‰¹é‡è·å–æ•°æ®, ä¿è¯ç¼“å­˜å’ŒDBä¸€è‡´æ€§
 * é“¾å¼ç¼“å­˜ï¼šæ”¯æŒå¤šå±‚ç¼“å­˜é“¾ã€‚å½“ä¸€ä¸ªç¼“å­˜å±‚è·å–æ•°æ®å¤±è´¥æ—¶ï¼Œä¼šè‡ªåŠ¨å°è¯•ä»ä¸‹ä¸€ä¸ªç¼“å­˜å±‚è·å–ã€‚
 * é”™è¯¯å¤„ç†ç­–ç•¥ï¼šæ”¯æŒå¤šç§é”™è¯¯å¤„ç†ç­–ç•¥ï¼ˆContinueã€Breakã€Retryï¼‰ï¼Œå¼€å‘è€…å¯ä»¥æ ¹æ®ä¸åŒçš„ç¼“å­˜å±‚é…ç½®ä¸åŒçš„å¤„ç†æ–¹å¼ã€‚
 * çµæ´»æ‰©å±•ï¼šå¯è½»æ¾é›†æˆå¤šä¸ªç¼“å­˜åç«¯ï¼Œå¹¶æ ¹æ®éœ€è¦æ·»åŠ æ–°çš„ç¼“å­˜å±‚ã€‚


### åœºæ™¯
 * å•ç‹¬ç”¨redisæ—è·¯ç¼“å­˜, å½“åšåˆ†å¸ƒå¼ç¼“å­˜çš„åœºæ™¯
 * memory + redis, å¯¹rediså‰é¢åŠ ä¸€å±‚å†…å­˜ç¼“å­˜, é€‚åˆqpséå¸¸é«˜, ä¸”èƒ½å¤Ÿæ¥å—æ•°æ®é€‚å½“å»¶è¿Ÿä¿®æ”¹çš„åœºæ™¯

### å®‰è£…

```
go get github.com/graymonster0927/component
```
### ä½¿ç”¨

åˆ›å»ºç¼“å­˜é“¾å®ä¾‹
```
    chain := cachechain.NewCacheChain()
    //åˆ›å»ºä¸€ä¸ª redis ç¼“å­˜
    redisCache := cache.NewRedisCache(
        //å¯ä»¥å®ç°è‡ªå·±çš„redisè¿æ¥
		cache.WithRedisConn(&RedisV8{}),
		cache.WithTokenPrefix("cachechain:servicename"),
	)
	
	// æ·»åŠ å¤šä¸ªç¼“å­˜å±‚ï¼ˆå¦‚å†…å­˜ç¼“å­˜ã€Redisç¼“å­˜ç­‰ï¼‰
	chain.WithCache(redisCache)

```
è·å–æ•°æ®
```
    chain := helpers.GetRedisCacheChain()
    //è®¾ç½®ç¼“å­˜å‰ç¼€ æ¯”å¦‚ servicename:xxx:%d
	chain.SetKeyPrefix(components.ApiResponseWhiteCacheKey)

	fn := func() (username, error) {
	    //æ•°æ®åº“æ“ä½œ æ¯”å¦‚æ ¹æ®ç”µè¯å·ç æ‹¿ç”¨æˆ·å
		return XXXXX()
	}
	chain.SetFnGetNoCache(func(cCtx context.Context, key string) (string, error) {
		return fn()
	})
    telephone := "12345678901"
	getRet := chain.Get(ctx, telephone)
    if !getRet.IsSuccess() {
        //ç¼“å­˜å¼‚å¸¸ ç›´æ¥ä¸èµ°ç¼“å­˜æ‹¿æ•°æ®
        return fn()
        //....
    }

    if v.Exist {
        //ç¼“å­˜å­˜åœ¨ å¤„ç† è¿”å›æ•°æ®
        //xxx
    }
```

å†™ç¼“å­˜
```
    chain := helpers.GetRedisCacheChain()
	chain.SetKeyPrefix(components.ApiResponseWhiteCacheKey)
	keyList := make([]string, len(relID))
	valList := make([]string, len(relID), len(relID))
	for i, v := range relID {
		keyList[i] = fmt.Sprintf("%d", v)
	}
	setRet := chain.BatchSet(ctx, keyList, valList)
    if !setRet.IsSuccess() {
        //é‡è¯•
        //è¿”å›å¼‚å¸¸
    }
```

æ‰¹é‡è·å–æ•°æ®
```
    chain := helpers.GetRedisCacheChain()
	chain.SetKeyPrefix(components.ApiResponseWhiteCacheKey)

	fn := func() ([]User, error) {
	    //æ•°æ®åº“æ‰¹é‡æ“ä½œ æ¯”å¦‚æ ¹æ®ç”µè¯å·ç æ‰¹é‡æ‹¿ç”¨æˆ·åˆ—è¡¨
		return XXXXX()
	}
	chain.SetFnBatchGetNoCache(func(cCtx context.Context, keyList []string) (map[string]string, error) {
	    ret := make(map[string]string)
		list, err := fn()
		for _, v := range list {
		    ret[v.telephone] = v.name
		}
		return ret, err
	})
    telephoneList := []string{"12345678901", "12345678902"}
	getRetMap := chain.BatchGet(ctx, telephoneList)
	for _, v := range getRetMap {
		if !v.IsSuccess() {
			//ç¼“å­˜å¼‚å¸¸ ç›´æ¥ä¸èµ°ç¼“å­˜æ‹¿æ•°æ®
			//list, err := fn()
			//....
		}

		if v.Exist {
			//ç¼“å­˜å­˜åœ¨ å¤„ç† è¿”å›æ•°æ®
			//xxx
		}
	}
```

æ‰¹é‡å†™ç¼“å­˜
```
    chain := helpers.GetRedisCacheChain()
	chain.SetKeyPrefix(components.ApiResponseWhiteCacheKey)
	keyList := make([]string, len(relID))
	valList := make([]string, len(relID), len(relID))
	for i, v := range relID {
		keyList[i] = fmt.Sprintf("%d", v)
	}
	setRetMap := chain.Set(ctx, keyList, valList)
	for _, v := range setRetMap {
		if !v.IsSuccess() {
			//é‡è¯•
            //è¿”å›å¼‚å¸¸
		}
	}
```

### é”™è¯¯å¤„ç†ç­–ç•¥
æ¯ä¸ªç¼“å­˜å±‚éƒ½å¯ä»¥è®¾ç½®é”™è¯¯å¤„ç†ç­–ç•¥ï¼Œä»¥å†³å®šåœ¨é‡åˆ°é”™è¯¯æ—¶çš„è¡Œä¸ºï¼š

* HandleErrStrategyContinueï¼šå¿½ç•¥é”™è¯¯ï¼Œç»§ç»­æ£€æŸ¥ä¸‹ä¸€ä¸ªç¼“å­˜å±‚ã€‚
* HandleErrStrategyBreakï¼šé‡åˆ°é”™è¯¯æ—¶åœæ­¢å¹¶è¿”å›é”™è¯¯ã€‚
* HandleErrStrategyRetryï¼šåœ¨é‡åˆ°é”™è¯¯æ—¶é‡è¯•æ“ä½œã€‚

### TODO
* æ”¯æŒæŒ‰ç±»å‹é…ç½®GetNoCacheå‡½æ•°, è¿™æ ·å…¨å±€å¯ä½¿ç”¨å•å®ä¾‹ç¼“å­˜é“¾
* é”™è¯¯å¤„ç†ç­–ç•¥æ”¯æŒå›æ»šç­–ç•¥
* å®ç°å†…å­˜ç¼“å­˜,æ–‡ä»¶ç¼“å­˜ç­‰
* å®Œå–„å‚æ•°æ ¡éªŒ

