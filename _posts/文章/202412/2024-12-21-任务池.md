---
title: ä»»åŠ¡æ± 
date: 2024-12-21
categories: [æ–‡ç« , '202412']
tags: [goç»„ä»¶]
---

# ç®€ä»‹

> ğŸ”—[GitHub](https://github.com/graymonster0927/component/tree/main/taskpool)

æœ¬é¡¹ç›®å®ç°äº†ä»»åŠ¡æ± , èƒ½å¤Ÿå¹¶å‘æ‰§è¡Œå¤šç§ä»»åŠ¡, æ¯”å¦‚ä»¥ä¸‹åœºæ™¯:  
1. å¹¶å‘æ‰§è¡Œå¤šä¸ªä»»åŠ¡, ä¸”éœ€è¦ç­‰å¾…æ‰€æœ‰ç»“æœ (åŒä¸€å¼ å›¾ -> åŒæ—¶ æ ¡éªŒAè§„åˆ™/æ ¡éªŒBè§„åˆ™/æ ¡éªŒCè§„åˆ™ -> ä»»ä¸€ä¸ªè§„åˆ™å¤±è´¥åˆ™ä¸å…è®¸å›¾ä¿å­˜)
2. å¹¶å‘æ‰§è¡Œå¤šä¸ªä»»åŠ¡, ä¸”è¦é™åˆ¶åç¨‹æ•°, é™åˆ¶å¹¶å‘æ‰§è¡Œä»»åŠ¡æ•°ç›® (æ¯”å¦‚é™åˆ¶ä¸€æ¬¡åªèƒ½æ‰§è¡Œ500ä¸ªæ‰«æç«¯å£çš„ä»»åŠ¡ é¿å…æ‰«æç«¯å£è¿‡å¤šå¯¼è‡´NATå‹åŠ›è¿‡å¤§)

## ä¼˜ç‚¹

âœ… å¹¶å‘æ‰§è¡Œï¼šgoroutineè½»é‡çº§ï¼Œèƒ½é«˜æ•ˆå¹¶å‘æ‰§è¡Œå¤§é‡ä»»åŠ¡ï¼Œæé«˜ååé‡ã€‚  
âœ… æ€§èƒ½ä¼˜åŒ–ï¼šå¼•å…¥antsåç¨‹æ± å¤ç”¨goroutineï¼Œé¿å…é¢‘ç¹åˆ›å»ºå’Œé”€æ¯ï¼Œå‡å°‘GCå¼€é”€ï¼Œæé«˜æ€§èƒ½ã€‚  
âœ… èµ„æºæ§åˆ¶ï¼šèƒ½å¤Ÿé™åˆ¶æœ€å¤§å¹¶å‘æ•°ï¼Œé˜²æ­¢ç³»ç»Ÿèµ„æºè€—å°½ï¼Œæå‡ç³»ç»Ÿç¨³å®šæ€§ã€‚  
âœ… ä»£ç ç®€æ´ï¼šç»Ÿä¸€å°è£…å¹¶å‘é€»è¾‘ï¼Œç®€åŒ–ä»£ç ï¼Œæé«˜å¯è¯»æ€§å’Œç»´æŠ¤æ€§ã€‚

## å¿«é€Ÿå¼€å§‹

### ä½¿ç”¨

#### å¹¶å‘æ‰§è¡Œå¤šä¸ªä»»åŠ¡, ä¸”éœ€è¦ç­‰å¾…æ‰€æœ‰ç»“æœ

> æ¯”å¦‚ åŒä¸€å¼ å›¾ -> åŒæ—¶ æ ¡éªŒAè§„åˆ™/æ ¡éªŒBè§„åˆ™/æ ¡éªŒCè§„åˆ™ -> ä»»ä¸€ä¸ªè§„åˆ™å¤±è´¥åˆ™ä¸å…è®¸å›¾ä¿å­˜   
   
```

const (
	TaskTypeDemo1 TaskType = 1
	TaskTypeDemo2 TaskType = 2
	TaskTypeDemo3 TaskType = 3
)

func main() {
	//è·å–ä»»åŠ¡æ± 
	ctx := context.Background()
	taskPool := GetTaskPool(&ctx)
	//è®¾ç½®åç¨‹æ± å¤§å°
    taskPool.SetGPoolSize(100)
	//è®¾ç½®ä»»åŠ¡æ± çš„ä»»åŠ¡å¤„ç†å‡½æ•°
	taskPool.SetTaskHandler(TaskTypeDemo1, func(ctx *context.Context, params map[string]interface{}) (interface{}, error) {
		fmt.Println("demo1")
		return nil, nil
	})

	say := "my name is a"
	taskPool.SetTaskHandler(TaskTypeDemo2, func(ctx *context.Context, params map[string]interface{}) (interface{}, error) {
		fmt.Println(say)
		return nil, nil
	})

	taskPool.SetTaskHandler(TaskTypeDemo3, func(ctx *context.Context, params map[string]interface{}) (interface{}, error) {
		p1 := params["p1"].(string)
		p2 := params["p2"].(int)
		fmt.Println(p1, p2)
		return nil, nil
	})

	//æ·»åŠ ä»»åŠ¡
	taskPool.AddTask(TaskTypeDemo1, "id-1", nil)
	taskPool.AddTask(TaskTypeDemo1, "id-2", nil)
	taskPool.AddTask(TaskTypeDemo2, "id-1", nil)

	params := map[string]interface{}{
		"p1": "a",
		"p2": 1,
	}
	taskPool.AddTask(TaskTypeDemo3, "id-1", params)

	if err := taskPool.Start(); err != nil {
		fmt.Println("task exception", err)
		return
	}

	fmt.Println(taskPool.errList)
	fmt.Println(taskPool.retList)

}


```

#### é™åˆ¶å¹¶å‘æ‰§è¡Œä»»åŠ¡æ•°ç›®

> æ¯”å¦‚é™åˆ¶ä¸€æ¬¡åªèƒ½æ‰§è¡Œ500ä¸ªæ‰«æç«¯å£çš„ä»»åŠ¡ é¿å…æ‰«æç«¯å£è¿‡å¤šå¯¼è‡´NATå‹åŠ›è¿‡å¤§   
   
```

const (
	TaskTypeDemo3 TaskType = 3
)

func main() {
	//è·å–ä»»åŠ¡æ± 
	ctx := context.Background()
	taskPool := GetTaskPool(&ctx)

	//è®¾ç½®ä»»åŠ¡æ± çš„ä»»åŠ¡å¤„ç†å‡½æ•°
	taskPool.SetTaskHandler(TaskTypeDemo3, func(ctx *context.Context, params map[string]interface{}) (interface{}, error) {
		p1 := params["p1"].(int)
		fmt.Println(p1+"port is scanning")
		return nil, nil
	})

	//æ·»åŠ ä»»åŠ¡
    for i := 0; i < 65535; i++ {
        count++
        params := map[string]interface{}{
		    "p1": i,
	    }
        taskPool.AddTask(TaskTypeDemo3, "id-"+strconv.Itoa(i), params)
        if count % 500 == 0 {
            if err := taskPool.Start(); err != nil {
                fmt.Println("task exception", err)
                return
            }
            
            //å¤„ç†ç»“æœ
            taskPool.Clear()
        }
    }
    
    if count % 500 > 0 {
        if err := taskPool.Start(); err != nil {
            fmt.Println("task exception", err)
            return
        }
        //å¤„ç†ç»“æœ
        taskPool.Clear()
    }

}

```
